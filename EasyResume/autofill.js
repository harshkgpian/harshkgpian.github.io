// jsonVersion.js

let defaultJson ={
  "personal": [
    {
      "name": "NAMAN KUMAR SAHU",
      "email": "naman.prayas51jee19@gmail.com",
      "phone": "+91-8269563206",
      "linkedin": "https://www.linkedin.com/in/naman-sahu-63907621a/"
    }
  ],
  "summary": [
    {
      "summary": "Highly motivated engineer with a Master's and Bachelor's degree in Aerospace Engineering from IIT Kharagpur, demonstrating strong analytical and problem-solving skills. Proven ability to deliver impactful projects in data analysis and machine learning. Seeking to leverage expertise in technical software and maritime knowledge to contribute to challenging marine engineering and ship management projects."
    }
  ],
  "education": [
    {
      "school": "Indian Institute of Technology Kharagpur",
      "degree": "Masters & Bachelors of Technology- Aerospace Engineering",
      "duration": "Sep 2020 - Present",
      "location": "Kharagpur, West Bengal, India",
      "scoreType": "CGPA",
      "gpa": "8.02/10"
    }
  ],
  "experience": [
    {
      "title": "Mining Disease-Symptom Relation for Severe Disease Diagnosis",
      "subtitle": "Summer Internship project|Prof. Koustav Rudra|IIT Kharagpur",
      "duration": "Jun’24 - Jul’24",
      "bullets": [
        "Extracted 1.6M textual abstracts from MEDLINE/PubMed using BeautifulSoup to analyze disease-symptom relations, demonstrating maritime knowledge in information retrieval.",
        "Queried and analyzed 8,514 diseases and 842 symptoms using Whoosh Python, quantifying occurrences and pairwise counts, showcasing strong technical software skills.",
        "Utilized NegEx library in an NLP pipeline with the en_core_web_sm spaCy model and enclinicaltermset for relation analysis, highlighting proficiency in advanced materials and data processing."
      ],
      "tags": [
        "Maritime knowledge",
        "technical software",
        "advanced materials"
      ]
    }
  ],
  "projects": [
    {
      "title": "Chat Based Intelligent Tour Planning Assistant",
      "duration": "Nov 2024",
      "bullets": [
        "Designed a Neo4j graph schema to manage user personas, traits, attributes, and preferences for personalized itinerary generation, showcasing maritime engineering design principles.",
        "Deployed Llama 3 for advanced NLP-driven preference extraction and intelligent real-time adaptive itinerary recommendations, demonstrating proficiency in technical software.",
        "Developed a fast workflow combining graph traversal and LLM insights to generate tailored itineraries for diverse user personas, reflecting strong problem-solving skills."
      ],
      "tags": [
        "Maritime engineering",
        "technical software",
        "problem-solving skills"
      ]
    },
    {
      "title": "Loan Eligibility Prediction",
      "subtitle": "IIT Kharagpur",
      "duration": "Apr’23 - May’23",
      "bullets": [
        "Analyzed lending club data across diverse borrower profiles to assess loan repayment behaviors, trends, and risk factors, applying analytical skills relevant to maritime inspections.",
        "Performed exploratory data analysis (EDA), data preprocessing, and identified feature correlation via correlation matrix, demonstrating strong data management capabilities.",
        "Transformed categorical values into numerical values using one-hot encoding and label encoding, handling diverse data types, showcasing technical software proficiency.",
        "Developed a 4-layer neural network model using TensorFlow library, trained the model, achieving prediction accuracy of 89%, highlighting expertise in machine learning."
      ],
      "tags": [
        "maritime inspections",
        "data management",
        "technical software"
      ]
    },
    {
      "title": "Automated Manufacturing Unit-State Prediction",
      "subtitle": "Data Analytics General Championship|IIT Kharagpur",
      "duration": "Feb’23 - Mar’23",
      "bullets": [
        "Performed a systematic analysis to assess the relative significance of different sensors in forecasting the product’s final outcome, a skill applicable to Maintenance & Repair operations.",
        "Performed Fault analysis using the z-score method and implemented data filtering with Kalman Filter for data pre-processing, showcasing problem-solving skills.",
        "Ensembled high-performing time series, DL and auto ML models - LSTM, 1D CNN, and AutoGluon achieving 94% accuracy, demonstrating proficiency in technical software.",
        "Secured gold medal in the Data Analytics General Championship by successfully predicting system states with high precision, highlighting strong performance standards."
      ],
      "tags": [
        "Maintenance & Repair",
        "problem-solving skills",
        "technical software",
        "performance standards"
      ]
    },
    {
      "title": "Cricket Match Result Prediction Algorithm",
      "subtitle": "American Express Decision Science Challenge",
      "duration": "Jun’24",
      "bullets": [
        "Developed a machine learning pipeline utilizing the gradient boosting algorithms to forecast the winner of T20 cricket matches, showcasing analytical skills applicable to ship management.",
        "Engineered over 20 features and implemented hyperparameter tuning, regularization, feature selection, and data normalization, demonstrating strong technical software skills.",
        "Deployed CatBoost and LightGBM models in an ensemble, achieving 68% accuracy and ranking top 30 out of 423 teams, highlighting collaborative team environment and performance standards."
      ],
      "tags": [
        "ship management",
        "technical software",
        "collaborative team environment",
        "performance standards"
      ]
    }
  ],
  "skills": [
    {
      "category": "Languages/Frameworks",
      "skills": [
        "Python",
        "C++",
        "SQL",
        "TensorFlow",
        "Keras",
        "PyTorch",
        "Scikit-learn",
        "Pandas",
        "NumPy",
        "Seaborn",
        "MATLAB"
      ]
    },
    {
      "category": "Software/ Developer Tools",
      "skills": [
        "VS Code",
        "Google Colab",
        "Jupyter Notebook",
        "Github",
        "MS Excel",
        "Canva",
        "MYSQL",
        "MATLAB"
      ]
    }
  ],
  "leadership": [
    {
      "title": "Captain Athletics",
      "organization": "Radhakrishnan Hall of Residence|IIT Kharagpur",
      "duration": "Aug’22 - Apr’24",
      "bullets": [
        "Executed athlete selection for 200+ participants, effectively mentored both junior and senior teams in Inter Hall Athletics event, demonstrating strong Operations and team management skills.",
        "Managed INR 70k budget for Inter Hall Athletics General Championship, provided logistical and equipment support in the event, showcasing financial management abilities.",
        "Led the team to a commendable bronze medal victory in Inter Hall Athletics 2023 and 2024, serving as a player and team leader, highlighting strong performance standards."
      ],
      "tags": [
        "Operations",
        "team management",
        "performance standards"
      ]
    },
    {
      "title": "Secretary Sports and Games",
      "organization": "Radhakrishnan Hall of Residence|IIT Kharagpur",
      "duration": "Jan’22 - Apr’22",
      "bullets": [
        "Elected by 680 boarders of RK hall for athletics in Sports and Games General Championship, overseeing a budget of INR 60k, demonstrating strong leadership skills.",
        "Led the team formation, conducted player trials to identify talented individuals, and organized training sessions to improve skills, showing proficiency in Operations.",
        "Implemented incentives to expand the fresher pool of probables and provided evaluation-feedback to nurture a competitive mindset, enhancing team performance."
      ],
      "tags": [
        "leadership skills",
        "Operations"
      ]
    }
  ],
  "awards": [
    {
      "title": "Ranked 6th and honored by the District Magistrate Gariyaband (C.G.)",
      "subtitle": "Exceptional performance in Prayas entrance exam",
      "duration": "",
      "bullets": [],
      "tags": []
    },
    {
      "title": "Sports official",
      "subtitle": "1st Children’s Athletics Championship IIT Kharagpur",
      "duration": "",
      "bullets": [
        "Managed 10+ events and over 150 participants."
      ],
      "tags": [
        "Operations"
      ]
    },
    {
      "title": "Won gold",
      "subtitle": "Hammer throw at 2nd Athletics Championship IIT Kharagpur 2023",
      "duration": "",
      "bullets": [
        "Competing over 150 players of Midnapore"
      ],
      "tags": []
    }
  ],
  "extracurricular": [
    {
      "title": "Secured 4th in Hammer Throw",
      "subtitle": "Supported gold-winning athletics team of IIT Kharagpur at 56th Inter IIT Sports Meet 2023",
      "duration": "",
      "bullets": [],
      "tags": []
    },
    {
      "title": "Secured silver in hammer throw",
      "subtitle": "1st Athletics Championship IIT Kharagpur’22",
      "duration": "",
      "bullets": [
        "Competing with 100+ players of Midnapore"
      ],
      "tags": []
    },
    {
      "title": "Core member",
      "subtitle": "Silver-winning Choreography team of RK Hall in Inter-Hall Social and Culture General Championship 2023",
      "duration": "",
      "bullets": [],
      "tags": []
    }
  ]
}

let demoJSON = defaultJson;


// Helper function to detect and register custom sections
function detectCustomSections() {
    // Look through the JSON for sections that might not be in the default config
    const standardSections = ['personal', 'summary', 'education', 'experience', 'projects', 'skills'];
    
    // Find custom sections in the demo JSON
    const customSections = Object.keys(demoJSON).filter(key => !standardSections.includes(key));
    
    // Register each custom section
    customSections.forEach(sectionKey => {
        // Format section name for display (capitalize first letter)
        const sectionTitle = sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1);
        
        // Check if we need to add to sectionCounter
        if (typeof sectionCounter !== 'undefined' && sectionCounter[sectionKey] === undefined) {
            sectionCounter[sectionKey] = 0;
        }
        
        // Check if we need to add to formData
        if (typeof formData !== 'undefined' && formData[sectionKey] === undefined) {
            formData[sectionKey] = [];
        }
        
        // Register the custom section in the config
        if (typeof updateConfigWithCustomSection === 'function') {
            updateConfigWithCustomSection(sectionKey, sectionTitle);
        } else {
            console.warn('updateConfigWithCustomSection function not found');
        }
        
        // Add button for the custom section if it doesn't exist
        createSectionButton(sectionKey, sectionTitle);
    });
    
    return customSections;
}

// Function to create buttons for custom sections
function createSectionButton(sectionKey, sectionTitle) {
    console.log('Creating button for custom section:', sectionKey);
    // Check if button already exists
    const existingButton = document.querySelector(`.add-btn[data-section="${sectionKey}"]`);
    if (existingButton) {
        return; // Don't create duplicates
    }
    
    // Create a new button and add it to the sidebar
    const sidebar = document.querySelector(".action-buttons");
    if (sidebar) {
        const newButton = document.createElement("button");
        newButton.className = "add-btn";
        newButton.setAttribute('data-section', sectionKey); // Mark with section type
        newButton.textContent = `Add ${sectionTitle}`;
        newButton.onclick = function() {
            if (typeof addSection === 'function') {
                addSection(sectionKey);
            } else {
                console.warn('addSection function not found');
            }
        };
        
        sidebar.appendChild(newButton);
    } else {
        console.warn('Sidebar element not found');
    }
}

// Function to clear all existing data before loading demo
function clearAllData() {
    // Get form container element and check if it exists
    const formContainer = document.getElementById('formContainer');
    if (formContainer) {
        formContainer.innerHTML = '';
    } else {
        console.warn('Form container element not found');
    }
    
    // Clear resume preview if it exists
    const resumeElement = document.getElementById('resume');
    if (resumeElement) {
        resumeElement.innerHTML = '';
    } else {
        console.warn('Resume element not found');
    }
    
    // Get all section types from the JSON
    const allSectionTypes = Object.keys(demoJSON);
    
    // Clear formData object
    if (typeof formData !== 'undefined') {
        // Reset formData with all section types
        formData = {
            personal: [],
            education: [],
            experience: [],
            projects: [],
            competitions: [],
            skills: []
        };
        
        // Add custom section types from JSON
        allSectionTypes.forEach(type => {
            if (!formData[type]) {
                formData[type] = [];
            }
        });
    } else {
        console.warn('formData variable not defined yet');
    }
    
    // Reset section counters
    if (typeof sectionCounter !== 'undefined') {
        sectionCounter = {
            personal: 0,
            education: 0,
            experience: 0,
            projects: 0,
            skills: 0,
            competitions: 0
        };
        
        // Add custom section types from JSON
        allSectionTypes.forEach(type => {
            if (!sectionCounter[type]) {
                sectionCounter[type] = 0;
            }
        });
    } else {
        console.warn('sectionCounter variable not defined yet');
    }
}

function populateSection(sectionType, sectionData) {
    if (!sectionData || !Array.isArray(sectionData) || sectionData.length === 0) {
        return;
    }

    sectionData.forEach(itemData => {
        addSection(sectionType);
        const sectionId = `${sectionType}-${sectionCounter[sectionType] - 1}`;
        const section = document.getElementById(sectionId);
        
        if (section) {
            Object.entries(itemData).forEach(([key, value]) => {
                if (key === 'bullets') {
                    // Find the bullets container
                    const bulletsContainer = section.querySelector(`#bullets-${sectionId}`);
                    if (bulletsContainer) {
                        // Clear any default bullet points
                        bulletsContainer.innerHTML = '';
                        
                        // Add each bullet point as a separate field
                        value.forEach(bulletText => {
                            addBulletField(sectionId, bulletsContainer, bulletText);
                        });
                    }
                } else if (key === 'tags') {
                    const input = section.querySelector('input[name="tags"]');
                    if (input) {
                        input.value = Array.isArray(value) ? value.join(', ') : value;
                    }
                } else if (key === 'skills') {
                    // Handle skills array for skills section
                    const skillsContainer = section.querySelector('.skills-container');
                    if (skillsContainer) {
                        value.forEach((skill, index) => {
                            if (index === 0) {
                                const firstSkillInput = skillsContainer.querySelector('input[name="skill"]');
                                if (firstSkillInput) {
                                    firstSkillInput.value = skill;
                                }
                            } else {
                                addSkillField(sectionId);
                                const inputs = skillsContainer.querySelectorAll('input[name="skill"]');
                                inputs[inputs.length - 1].value = skill;
                            }
                        });
                    }
                } else if (key === 'summary' && sectionType === 'summary') {
                    // Special handling for summary text
                    const textarea = section.querySelector('textarea[name="summary"]');
                    if (textarea) {
                        textarea.value = value;
                    }
                } else {
                    const input = section.querySelector(`input[name="${key}"]`);
                    const textarea = section.querySelector(`textarea[name="${key}"]`);
                    if (input) {
                        input.value = value;
                    } else if (textarea) {
                        textarea.value = value;
                    }
                }
            });
            updateFormData(sectionId);
            
            // Update section title
            let titleField = null;
            if (sectionType === 'education') {
                titleField = section.querySelector('input[name="school"]');
            } else if (sectionType === 'summary') {
                titleField = { value: 'Professional Summary' }; // Static title for summary
            } else if (sectionType === 'skills') {
                titleField = section.querySelector('input[name="category"]');
            } else if (sectionType === 'personal') {
                titleField = section.querySelector('input[name="name"]');
            }  else {
                titleField = section.querySelector('input[name="title"]');
            }
            
            if (titleField && titleField.value) {
                updateSectionTitle(sectionId, sectionType, titleField.value);
            }
        }
    });
}


function populateFromDemoJSON() {
    try {
        // First, detect and register any custom sections from the JSON
        const customSections = detectCustomSections();
        console.log('Detected custom sections:', customSections);
        
        // Update section order to include custom sections
        if (typeof sectionOrder !== 'undefined') {
            customSections.forEach(section => {
                if (!sectionOrder.includes(section)) {
                    sectionOrder.push(section);
                }
            });
            console.log('Updated section order:', sectionOrder);
        }
        
        // Populate all sections using our helper function
        Object.entries(demoJSON).forEach(([sectionType, sectionData]) => {
            if (sectionType !== 'skills') { // Skills needs special handling
                populateSection(sectionType, sectionData);
            }
        });
        
        // Special handling for Skills section
        if (demoJSON.skills && Array.isArray(demoJSON.skills)) {
            demoJSON.skills.forEach(skillCategory => {
                addSection('skills');
                const sectionId = `skills-${sectionCounter.skills - 1}`;
                const section = document.getElementById(sectionId);
                
                if (section) {
                    // Set category
                    const categoryInput = section.querySelector('input[name="category"]');
                    if (categoryInput) {
                        categoryInput.value = skillCategory.category;
                    }

                    // Add skills
                    const skillsContainer = section.querySelector('.skills-container');
                    if (skillsContainer) {
                        skillCategory.skills.forEach((skill, index) => {
                            if (index === 0) {
                                // Use existing first skill input
                                const firstSkillInput = skillsContainer.querySelector('input[name="skill"]');
                                if (firstSkillInput) {
                                    firstSkillInput.value = skill;
                                }
                            } else {
                                // Add new skill input for remaining skills
                                addSkillField(sectionId);
                                const inputs = skillsContainer.querySelectorAll('input[name="skill"]');
                                inputs[inputs.length - 1].value = skill;
                            }
                        });
                    }
                    updateFormData(sectionId);
                }
            });
        }

        // Generate resume preview
        console.log('Demo data loaded', sectionOrder);
        if (typeof generateResume === 'function' && typeof sectionOrder !== 'undefined') {
            generateResume(sectionOrder);
        } else {
            console.warn('generateResume function or sectionOrder not found');
        }
    } catch (error) {
        console.error('Error loading demo data:', error);
    }
}



// Function to load demo data
function loadDemoData() {
    try {
        // Clear any existing data before loading demo
        clearAllData();
        
        // Populate with demo data
        populateFromDemoJSON();
    } catch (error) {
        console.error('Error in loadDemoData:', error);
    }
}

function loadDefaultData() {
    try {
        // Clear any existing data before loading demo
        clearAllData();
        
        // Populate with demo data
        demoJSON = defaultJson;
        populateFromDemoJSON();
    } catch (error) {
        console.error('Error in loadDemoData:', error);
    }
}

// Function to create updated JSON from all form data
function createUpdatedJSON() {
    // Initialize the JSON structure with the same format as demoJSON
    const updatedJSON = {};
    
    // Collect data from all section types defined in sectionCounter
    Object.keys(sectionCounter).forEach(sectionType => {
      if (!updatedJSON[sectionType]) {
        updatedJSON[sectionType] = [];
      }
      
      // Skip if no data exists for this section type
      if (!formData[sectionType] || formData[sectionType].length === 0) {
        return;
      }
      
      // Process each item in this section type
      formData[sectionType].forEach(item => {
        const sectionData = {};
        
        // Handle special case for summary
        if (sectionType === 'summary') {
          if (item.fields.summary) {
            sectionData.summary = item.fields.summary;
          }
        } 
        // Handle special case for skills
        else if (sectionType === 'skills') {
          sectionData.category = item.fields.category || '';
          sectionData.skills = item.fields.skills || [];
        } 
        // Handle all other fields for standard and custom sections
        else {
          // Copy all fields except bullets and tags which need special handling
          Object.keys(item.fields).forEach(fieldName => {
            if (fieldName !== 'bullets' && fieldName !== 'tags' && fieldName !== 'skills') {
              sectionData[fieldName] = item.fields[fieldName] || '';
            }
          });
          
          // Handle bullets
          if (item.fields.bullets) {
            sectionData.bullets = Array.isArray(item.fields.bullets) ? 
              item.fields.bullets : 
              (typeof item.fields.bullets === 'string' ? 
                item.fields.bullets.split('\n').filter(b => b.trim() !== '') : []);
          }
          
          // Handle tags
          if (item.fields.tags) {
            sectionData.tags = typeof item.fields.tags === 'string' ? 
              item.fields.tags.split(',').map(tag => tag.trim()).filter(tag => tag !== '') : 
              (Array.isArray(item.fields.tags) ? item.fields.tags : []);
          }
        }
        
        // Only add non-empty section data
        if (Object.keys(sectionData).length > 0) {
          updatedJSON[sectionType].push(sectionData);
        }
      });
      
      // Remove empty arrays
      if (updatedJSON[sectionType].length === 0) {
        delete updatedJSON[sectionType];
      }
    });
    
    return updatedJSON;
  }
  
  // Function to log the updated JSON to console
  function logUpdatedJSON() {
    const updatedJSON = createUpdatedJSON();
    console.log('Updated Resume JSON:');
    console.log(JSON.stringify(updatedJSON, null, 2));
        
    return updatedJSON;
  }
  
  
// Remove the JSON buttons function completely
function addJSONButtons() {
    // This function is now empty - we're removing the buttons
  }
  
  // Save to localStorage when JSON is updated
  function saveToLocalStorage() {
    const updatedJSON = createUpdatedJSON();
    const updatedsectionOrder = getSectionOrder();
    localStorage.setItem('sectionOrder', updatedsectionOrder);
    localStorage.setItem('resumeData', JSON.stringify(updatedJSON));
  }
  
  // Modified window.onload function
  window.onload = function() {
    try {
      // Check if there's data in localStorage
      const savedData = localStorage.getItem('resumeData');
      const savedOrder = localStorage.getItem('sectionOrder');
      
      if (savedData && savedOrder) {
        // Use the saved data
        demoJSON = JSON.parse(savedData);
        sectionOrder = savedOrder.split(',');
        console.log('sectionOrder from localStorage:', sectionOrder);
        console.log('Loaded data from localStorage');
      }
      
      // Load data (either from localStorage or the default demo)
      loadDemoData();
      
      // Setup event listener to save on form changes
      document.addEventListener('change', saveToLocalStorage);
      
      // Initialize collapsed sections if the function exists
      if (typeof initializeCollapsedGroups === 'function') {
        initializeCollapsedGroups();
      }
    } catch (error) {
      console.error('Error in window.onload:', error);
    }
  };
