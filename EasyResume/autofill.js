// jsonVersion.js

let defaultJson ={
  "personal": [
    {
      "name": "NAMAN KUMAR SAHU",
      "email": "naman.prayas51jee19@gmail.com",
      "phone": "+91-8269563206",
      "linkedin": "https://www.linkedin.com/in/naman-sahu-63907621a/"
    }
  ],
  "summary": [
    {
      "summary": "Highly motivated Aerospace Engineering graduate with a Masters and Bachelors of Technology from IIT Kharagpur, demonstrating strong skills in data analytics, machine learning, and problem-solving. Successfully developed simulation software and applied numerical methods for optimization challenges. Proficient in Python, MATLAB, and deep learning frameworks. Eager to leverage these skills to contribute to innovative solutions in battery technology and the broader field of data science."
    }
  ],
  "education": [
    {
      "school": "Indian Institute of Technology Kharagpur",
      "degree": "Masters & Bachelors of Technology- Aerospace Engineering",
      "duration": "September 2020 - Present",
      "scoreType": "CGPA",
      "gpa": "8.02/10"
    }
  ],
  "experience": [
    {
      "title": "IIT Kharagpur",
      "subtitle": "Summer Internship project",
      "duration": "June 2024 - July 2024",
      "bullets": [
        "Extracted 1.6M textual abstracts from MEDLINE/PubMed using BeautifulSoup for comprehensive analysis of disease-symptom relations, demonstrating strong data analytics skills in a real-world application.",
        "Queried and meticulously analyzed 8,514 diseases and 842 symptoms using Whoosh Python, accurately quantifying occurrences and pairwise counts to identify significant correlations.",
        "Utilized NegEx library within a sophisticated NLP pipeline incorporating the en_core_web_sm spaCy model and enclinicaltermset for nuanced relation analysis in medical text."
      ],
      "tags": [
        "data analytics",
        "NLP",
        "Python"
      ]
    }
  ],
  "projects": [
    {
      "title": "Chat Based Intelligent Tour Planning Assistant",
      "duration": "November 2024",
      "bullets": [
        "Designed an efficient Neo4j graph schema to effectively manage intricate user personas, encompassing diverse traits, attributes, and preferences for highly personalized itinerary generation.",
        "Deployed the advanced Llama 3 model for sophisticated NLP-driven preference extraction and the provision of intelligent real-time adaptive itinerary recommendations to enhance user experience.",
        "Developed a streamlined workflow that strategically combines rapid graph traversal techniques and insightful LLM outputs to generate uniquely tailored itineraries catering to a wide range of diverse user personas."
      ],
      "tags": [
        "NLP",
        "Neo4j"
      ]
    },
    {
      "title": "Loan Eligibility Prediction",
      "duration": "April 2023 - May 2023",
      "bullets": [
        "Conducted a thorough analysis of lending club data across diverse borrower profiles, to accurately assess the historical loan repayment behaviors, identify key financial trends, and pinpoint critical risk factors.",
        "Performed comprehensive exploratory data analysis (EDA) and rigorous data prepossessing, effectively identifying crucial feature correlation through the application of a correlation matrix.",
        "Skillfully transformed diverse categorical values into usable numerical representations using both one-hot encoding and label encoding techniques, adeptly handling various complex data types.",
        "Developed a robust 4-layer neural network model utilizing the TensorFlow library, diligently trained the model with optimized parameters, ultimately achieving a commendable prediction accuracy of 89%, clearly demonstrating machine learning expertise."
      ],
      "tags": [
        "machine learning",
        "data analytics",
        "TensorFlow"
      ]
    },
    {
      "title": "Automated Manufacturing Unit-State Prediction",
      "duration": "February 2023 - March 2023",
      "bullets": [
        "Performed a systematic and detailed analysis to accurately assess the relative significance and impact of different sensors in reliably forecasting the final outcome of the manufactured product.",
        "Executed thorough Fault analysis utilizing the z-score method and implemented effective data filtering techniques with the Kalman Filter for enhanced data pre-processing and noise reduction.",
        "Expertly ensembled high-performing time series, deep learning (DL), and automated machine learning (auto ML) models - specifically LSTM, 1D CNN, and AutoGluon - achieving an impressive 94% prediction accuracy.",
        "Successfully secured the gold medal in the Data Analytics General Championship by consistently and accurately predicting complex system states with a high degree of precision and reliability."
      ],
      "tags": [
        "data analytics",
        "machine learning"
      ]
    },
    {
      "title": "Cricket Match Result Prediction Algorithm",
      "duration": "June 2024",
      "bullets": [
        "Developed a comprehensive machine learning pipeline strategically utilizing advanced gradient boosting algorithms to accurately forecast the winner of dynamic T20 cricket matches.",
        "Meticulously engineered over 20 relevant features and implemented crucial techniques including hyperparameter tuning, regularization, feature selection, and effective data normalization.",
        "Successfully deployed both CatBoost and LightGBM models within a powerful ensemble framework, achieving a notable 68% prediction accuracy and securing a top 30 ranking out of 423 participating teams."
      ],
      "tags": [
        "machine learning",
        "data analytics"
      ]
    }
  ],
  "leadership": [
    {
      "title": "Captain Athletics",
      "organization": "Radhakrishnan Hall of Residence|IIT Kharagpur",
      "duration": "August 2022 - April 2024",
      "bullets": [
        "Efficiently executed the athlete selection process for over 200 participants, while also effectively mentoring both junior and senior teams participating in the highly competitive Inter Hall Athletics event.",
        "Responsibly managed a budget of INR 70,000 for the Inter Hall Athletics General Championship, ensuring the provision of essential logistical and equipment support throughout the entire event.",
        "Successfully led the team to a commendable bronze medal victory in both the Inter Hall Athletics events of 2023 and 2024, demonstrating strong leadership skills while also actively participating as a key player."
      ],
      "tags": [
        "leadership",
        "management"
      ]
    },
    {
      "title": "Secretary Sports and Games",
      "organization": "Radhakrishnan Hall of Residence|IIT Kharagpur",
      "duration": "January 2022 - April 2022",
      "bullets": [
        "Elected by 680 boarders of RK hall to represent athletics in the prestigious Sports and Games General Championship, effectively overseeing a budget of INR 60,000 for all sporting activities.",
        "Skillfully led the team formation process, conducted rigorous player trials to accurately identify talented individuals, and organized focused training sessions aimed at significantly improving overall team skills and performance.",
        "Proactively implemented strategic incentives designed to expand the fresher pool of potential team members and provided constructive evaluation-feedback mechanisms to consistently nurture a competitive mindset within the entire team."
      ],
      "tags": [
        "leadership",
        "management"
      ]
    }
  ],
  "skills": [
    {
      "category": "Languages/Frameworks",
      "skills": [
        "Python",
        "C++",
        "SQL",
        "TensorFlow",
        "Keras",
        "PyTorch",
        "Scikit-learn",
        "Pandas",
        "NumPy",
        "Seaborn",
        "MATLAB"
      ]
    },
    {
      "category": "Software/ Developer Tools",
      "skills": [
        "VS Code",
        "Google Colab",
        "Jupyter Notebook",
        "Github",
        "MS Excel",
        "Canva",
        "MYSQL",
        "MATLAB"
      ]
    }
  ],
  "awards": [
    {
      "title": "Ranked 6th",
      "organization": "District Magistrate Gariyaband (C.G.)",
      "duration": null,
      "bullets": [
        "Achieved 6th rank and was honored by the District Magistrate Gariyaband (C.G.) for exceptional performance in the Prayas entrance examination."
      ],
      "tags": []
    },
    {
      "title": "Sports official",
      "organization": "1st Children’s Athletics Championship IIT Kharagpur",
      "duration": null,
      "bullets": [
        "Served as a sports official at the 1st Children’s Athletics Championship IIT Kharagpur, efficiently managing over 10 events and coordinating more than 150 participants."
      ],
      "tags": []
    },
    {
      "title": "Won gold",
      "organization": "2nd Athletics Championship IIT Kharagpur 2023",
      "duration": null,
      "bullets": [
        "Won a gold medal in the hammer throw event at the 2nd Athletics Championship IIT Kharagpur 2023, successfully competing against over 150 players from the Midnapore region."
      ],
      "tags": []
    }
  ],
  "extracurricular": [
    {
      "title": "4th in Hammer Throw",
      "organization": "56th Inter IIT Sports Meet 2023",
      "duration": null,
      "bullets": [
        "Secured 4th position in the Hammer Throw event and actively supported the gold-winning athletics team of IIT Kharagpur at the prestigious 56th Inter IIT Sports Meet 2023."
      ],
      "tags": []
    },
    {
      "title": "Silver in hammer throw",
      "organization": "1st Athletics Championship IIT Kharagpur’22",
      "duration": null,
      "bullets": [
        "Achieved a silver medal in the hammer throw event at the 1st Athletics Championship IIT Kharagpur’22, successfully competing with over 100 players from the Midnapore region."
      ],
      "tags": []
    },
    {
      "title": "Core member",
      "organization": "Inter-Hall Social and Culture General Championship 2023",
      "duration": null,
      "bullets": [
        "Served as a core member of the silver-winning Choreography team representing RK Hall in the Inter-Hall Social and Culture General Championship 2023."
      ],
      "tags": []
    }
  ]
}

let demoJSON = defaultJson;


// Helper function to detect and register custom sections
function detectCustomSections() {
    // Look through the JSON for sections that might not be in the default config
    const standardSections = ['personal', 'summary', 'education', 'experience', 'projects', 'skills'];
    
    // Find custom sections in the demo JSON
    const customSections = Object.keys(demoJSON).filter(key => !standardSections.includes(key));
    
    // Register each custom section
    customSections.forEach(sectionKey => {
        // Format section name for display (capitalize first letter)
        const sectionTitle = sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1);
        
        // Check if we need to add to sectionCounter
        if (typeof sectionCounter !== 'undefined' && sectionCounter[sectionKey] === undefined) {
            sectionCounter[sectionKey] = 0;
        }
        
        // Check if we need to add to formData
        if (typeof formData !== 'undefined' && formData[sectionKey] === undefined) {
            formData[sectionKey] = [];
        }
        
        // Register the custom section in the config
        if (typeof updateConfigWithCustomSection === 'function') {
            updateConfigWithCustomSection(sectionKey, sectionTitle);
        } else {
            console.warn('updateConfigWithCustomSection function not found');
        }
        
        // Add button for the custom section if it doesn't exist
        createSectionButton(sectionKey, sectionTitle);
    });
    
    return customSections;
}

// Function to create buttons for custom sections
function createSectionButton(sectionKey, sectionTitle) {
    console.log('Creating button for custom section:', sectionKey);
    // Check if button already exists
    const existingButton = document.querySelector(`.add-btn[data-section="${sectionKey}"]`);
    if (existingButton) {
        return; // Don't create duplicates
    }
    
    // Create a new button and add it to the sidebar
    const sidebar = document.querySelector(".action-buttons");
    if (sidebar) {
        const newButton = document.createElement("button");
        newButton.className = "add-btn";
        newButton.setAttribute('data-section', sectionKey); // Mark with section type
        newButton.textContent = `Add ${sectionTitle}`;
        newButton.onclick = function() {
            if (typeof addSection === 'function') {
                addSection(sectionKey);
            } else {
                console.warn('addSection function not found');
            }
        };
        
        sidebar.appendChild(newButton);
    } else {
        console.warn('Sidebar element not found');
    }
}

// Function to clear all existing data before loading demo
function clearAllData() {
    // Get form container element and check if it exists
    const formContainer = document.getElementById('formContainer');
    if (formContainer) {
        formContainer.innerHTML = '';
    } else {
        console.warn('Form container element not found');
    }
    
    // Clear resume preview if it exists
    const resumeElement = document.getElementById('resume');
    if (resumeElement) {
        resumeElement.innerHTML = '';
    } else {
        console.warn('Resume element not found');
    }
    
    // Get all section types from the JSON
    const allSectionTypes = Object.keys(demoJSON);
    
    // Clear formData object
    if (typeof formData !== 'undefined') {
        // Reset formData with all section types
        formData = {
            personal: [],
            education: [],
            experience: [],
            projects: [],
            competitions: [],
            skills: []
        };
        
        // Add custom section types from JSON
        allSectionTypes.forEach(type => {
            if (!formData[type]) {
                formData[type] = [];
            }
        });
    } else {
        console.warn('formData variable not defined yet');
    }
    
    // Reset section counters
    if (typeof sectionCounter !== 'undefined') {
        sectionCounter = {
            personal: 0,
            education: 0,
            experience: 0,
            projects: 0,
            skills: 0,
            competitions: 0
        };
        
        // Add custom section types from JSON
        allSectionTypes.forEach(type => {
            if (!sectionCounter[type]) {
                sectionCounter[type] = 0;
            }
        });
    } else {
        console.warn('sectionCounter variable not defined yet');
    }
}

function populateSection(sectionType, sectionData) {
    if (!sectionData || !Array.isArray(sectionData) || sectionData.length === 0) {
        return;
    }

    sectionData.forEach(itemData => {
        addSection(sectionType);
        const sectionId = `${sectionType}-${sectionCounter[sectionType] - 1}`;
        const section = document.getElementById(sectionId);
        
        if (section) {
            Object.entries(itemData).forEach(([key, value]) => {
                if (key === 'bullets') {
                    // Find the bullets container
                    const bulletsContainer = section.querySelector(`#bullets-${sectionId}`);
                    if (bulletsContainer) {
                        // Clear any default bullet points
                        bulletsContainer.innerHTML = '';
                        
                        // Add each bullet point as a separate field
                        value.forEach(bulletText => {
                            addBulletField(sectionId, bulletsContainer, bulletText);
                        });
                    }
                } else if (key === 'tags') {
                    const input = section.querySelector('input[name="tags"]');
                    if (input) {
                        input.value = Array.isArray(value) ? value.join(', ') : value;
                    }
                } else if (key === 'skills') {
                    // Handle skills array for skills section
                    const skillsContainer = section.querySelector('.skills-container');
                    if (skillsContainer) {
                        value.forEach((skill, index) => {
                            if (index === 0) {
                                const firstSkillInput = skillsContainer.querySelector('input[name="skill"]');
                                if (firstSkillInput) {
                                    firstSkillInput.value = skill;
                                }
                            } else {
                                addSkillField(sectionId);
                                const inputs = skillsContainer.querySelectorAll('input[name="skill"]');
                                inputs[inputs.length - 1].value = skill;
                            }
                        });
                    }
                } else if (key === 'summary' && sectionType === 'summary') {
                    // Special handling for summary text
                    const textarea = section.querySelector('textarea[name="summary"]');
                    if (textarea) {
                        textarea.value = value;
                    }
                } else {
                    const input = section.querySelector(`input[name="${key}"]`);
                    const textarea = section.querySelector(`textarea[name="${key}"]`);
                    if (input) {
                        input.value = value;
                    } else if (textarea) {
                        textarea.value = value;
                    }
                }
            });
            updateFormData(sectionId);
            
            // Update section title
            let titleField = null;
            if (sectionType === 'education') {
                titleField = section.querySelector('input[name="school"]');
            } else if (sectionType === 'summary') {
                titleField = { value: 'Professional Summary' }; // Static title for summary
            } else if (sectionType === 'skills') {
                titleField = section.querySelector('input[name="category"]');
            } else if (sectionType === 'personal') {
                titleField = section.querySelector('input[name="name"]');
            }  else {
                titleField = section.querySelector('input[name="title"]');
            }
            
            if (titleField && titleField.value) {
                updateSectionTitle(sectionId, sectionType, titleField.value);
            }
        }
    });
}


function populateFromDemoJSON() {
    try {
        // First, detect and register any custom sections from the JSON
        const customSections = detectCustomSections();
        console.log('Detected custom sections:', customSections);
        
        // Update section order to include custom sections
        if (typeof sectionOrder !== 'undefined') {
            customSections.forEach(section => {
                if (!sectionOrder.includes(section)) {
                    sectionOrder.push(section);
                }
            });
            console.log('Updated section order:', sectionOrder);
        }
        
        // Populate all sections using our helper function
        Object.entries(demoJSON).forEach(([sectionType, sectionData]) => {
            if (sectionType !== 'skills') { // Skills needs special handling
                populateSection(sectionType, sectionData);
            }
        });
        
        // Special handling for Skills section
        if (demoJSON.skills && Array.isArray(demoJSON.skills)) {
            demoJSON.skills.forEach(skillCategory => {
                addSection('skills');
                const sectionId = `skills-${sectionCounter.skills - 1}`;
                const section = document.getElementById(sectionId);
                
                if (section) {
                    // Set category
                    const categoryInput = section.querySelector('input[name="category"]');
                    if (categoryInput) {
                        categoryInput.value = skillCategory.category;
                    }

                    // Add skills
                    const skillsContainer = section.querySelector('.skills-container');
                    if (skillsContainer) {
                        skillCategory.skills.forEach((skill, index) => {
                            if (index === 0) {
                                // Use existing first skill input
                                const firstSkillInput = skillsContainer.querySelector('input[name="skill"]');
                                if (firstSkillInput) {
                                    firstSkillInput.value = skill;
                                }
                            } else {
                                // Add new skill input for remaining skills
                                addSkillField(sectionId);
                                const inputs = skillsContainer.querySelectorAll('input[name="skill"]');
                                inputs[inputs.length - 1].value = skill;
                            }
                        });
                    }
                    updateFormData(sectionId);
                }
            });
        }

        // Generate resume preview
        console.log('Demo data loaded', sectionOrder);
        if (typeof generateResume === 'function' && typeof sectionOrder !== 'undefined') {
            generateResume(sectionOrder);
        } else {
            console.warn('generateResume function or sectionOrder not found');
        }
    } catch (error) {
        console.error('Error loading demo data:', error);
    }
}



// Function to load demo data
function loadDemoData() {
    try {
        // Clear any existing data before loading demo
        clearAllData();
        
        // Populate with demo data
        populateFromDemoJSON();
    } catch (error) {
        console.error('Error in loadDemoData:', error);
    }
}

function loadDefaultData() {
    try {
        // Clear any existing data before loading demo
        clearAllData();
        
        // Populate with demo data
        demoJSON = defaultJson;
        populateFromDemoJSON();
    } catch (error) {
        console.error('Error in loadDemoData:', error);
    }
}

// Function to create updated JSON from all form data
function createUpdatedJSON() {
    // Initialize the JSON structure with the same format as demoJSON
    const updatedJSON = {};
    
    // Collect data from all section types defined in sectionCounter
    Object.keys(sectionCounter).forEach(sectionType => {
      if (!updatedJSON[sectionType]) {
        updatedJSON[sectionType] = [];
      }
      
      // Skip if no data exists for this section type
      if (!formData[sectionType] || formData[sectionType].length === 0) {
        return;
      }
      
      // Process each item in this section type
      formData[sectionType].forEach(item => {
        const sectionData = {};
        
        // Handle special case for summary
        if (sectionType === 'summary') {
          if (item.fields.summary) {
            sectionData.summary = item.fields.summary;
          }
        } 
        // Handle special case for skills
        else if (sectionType === 'skills') {
          sectionData.category = item.fields.category || '';
          sectionData.skills = item.fields.skills || [];
        } 
        // Handle all other fields for standard and custom sections
        else {
          // Copy all fields except bullets and tags which need special handling
          Object.keys(item.fields).forEach(fieldName => {
            if (fieldName !== 'bullets' && fieldName !== 'tags' && fieldName !== 'skills') {
              sectionData[fieldName] = item.fields[fieldName] || '';
            }
          });
          
          // Handle bullets
          if (item.fields.bullets) {
            sectionData.bullets = Array.isArray(item.fields.bullets) ? 
              item.fields.bullets : 
              (typeof item.fields.bullets === 'string' ? 
                item.fields.bullets.split('\n').filter(b => b.trim() !== '') : []);
          }
          
          // Handle tags
          if (item.fields.tags) {
            sectionData.tags = typeof item.fields.tags === 'string' ? 
              item.fields.tags.split(',').map(tag => tag.trim()).filter(tag => tag !== '') : 
              (Array.isArray(item.fields.tags) ? item.fields.tags : []);
          }
        }
        
        // Only add non-empty section data
        if (Object.keys(sectionData).length > 0) {
          updatedJSON[sectionType].push(sectionData);
        }
      });
      
      // Remove empty arrays
      if (updatedJSON[sectionType].length === 0) {
        delete updatedJSON[sectionType];
      }
    });
    
    return updatedJSON;
  }
  
  // Function to log the updated JSON to console
  function logUpdatedJSON() {
    const updatedJSON = createUpdatedJSON();
    console.log('Updated Resume JSON:');
    console.log(JSON.stringify(updatedJSON, null, 2));
        
    return updatedJSON;
  }
  
  
// Remove the JSON buttons function completely
function addJSONButtons() {
    // This function is now empty - we're removing the buttons
  }
  
  // Save to localStorage when JSON is updated
  function saveToLocalStorage() {
    const updatedJSON = createUpdatedJSON();
    const updatedsectionOrder = getSectionOrder();
    localStorage.setItem('sectionOrder', updatedsectionOrder);
    localStorage.setItem('resumeData', JSON.stringify(updatedJSON));
  }
  
  // Modified window.onload function
  window.onload = function() {
    try {
      // Check if there's data in localStorage
      const savedData = localStorage.getItem('resumeData');
      const savedOrder = localStorage.getItem('sectionOrder');
      
      if (savedData && savedOrder) {
        // Use the saved data
        demoJSON = JSON.parse(savedData);
        sectionOrder = savedOrder.split(',');
        console.log('sectionOrder from localStorage:', sectionOrder);
        console.log('Loaded data from localStorage');
      }
      
      // Load data (either from localStorage or the default demo)
      loadDemoData();
      
      // Setup event listener to save on form changes
      document.addEventListener('change', saveToLocalStorage);
      
      // Initialize collapsed sections if the function exists
      if (typeof initializeCollapsedGroups === 'function') {
        initializeCollapsedGroups();
      }
    } catch (error) {
      console.error('Error in window.onload:', error);
    }
  };
