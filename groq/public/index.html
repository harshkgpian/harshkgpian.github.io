<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Girlfriend</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Create Your Virtual Girlfriend</h1>
        <form id="girlfriendForm" class="input-form">
            <div class="input-group">
                <label for="userName">Your Name:</label>
                <input type="text" id="userName" name="userName" required>
            </div>
            <div class="input-group">
                <label for="girlfriendName">Girlfriend's Name:</label>
                <input type="text" id="girlfriendName" name="girlfriendName" required>
            </div>
            <div class="input-group">
                <label for="girlfriendPersonality">Girlfriend's Personality:</label>
                <select id="girlfriendPersonality" name="girlfriendPersonality" required>
                    <option value="">Select Personality</option>
                    <option value="Witty and Caring">Witty and Caring</option>
                    <option value="Sassy and Playful">Sassy and Playful</option>
                    <option value="Sweet and Romantic">Sweet and Romantic</option>
                    <option value="Intelligent and Empathetic">Intelligent and Empathetic</option>
                    <option value="Naughty and Flirtatious">Naughty and Flirtatious</option>
                </select>
            </div>
            <div class="input-group">
                <label for="girlfriendInterests">Girlfriend's Interests:</label>
                <input type="text" id="girlfriendInterests" name="girlfriendInterests" required>
           </div>
            <div id="girlfriendMessage" class="message-container"></div>
            <div class="input-group message-input-group">
                <input type="text" id="message" name="message" autocomplete="off" required maxlength="300">
                <button type="submit" id="sendMessageButton"><img src="send_icon.png" alt="Send" width="25px" height="20px"></button>
            </div>
        </form>
    </div>

    <script>
        document.getElementById('girlfriendForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const userName = document.getElementById('userName').value;
            const girlfriendName = document.getElementById('girlfriendName').value;
            const girlfriendPersonality = document.getElementById('girlfriendPersonality').value;
            const girlfriendInterests = document.getElementById('girlfriendInterests').value;
            const message = document.getElementById('message').value;

            if (message.length > 300) {
                alert("Sorry, you can't have a message longer than 300 characters.");
                return;
            }

            createVirtualGirlfriend(userName, girlfriendName, girlfriendPersonality, girlfriendInterests, message);
        });

        let conversationHistory = []; // Store conversation history

        async function createVirtualGirlfriend(userName, girlfriendName, girlfriendPersonality, girlfriendInterests, message) {
            if (message.toLowerCase().includes("bye") || message.toLowerCase().includes("exit")) {
                displayConversation([{ role: 'girlfriend', content: "Goodbye! Have a great day!" }], userName, girlfriendName);
                return;
            }

            if (conversationHistory.length >= 20) {
                displayConversation([{ role: 'girlfriend', content: "Sorry, this is it for today. It costs a little to have more conversation. Contact the creator." }], userName, girlfriendName);
                return;
            }

            // Append the latest message to the conversation history
            conversationHistory.push({ role: 'user', content: message });

            // Display the user message
            displayConversation(conversationHistory, userName, girlfriendName);

            // Clear the message input box after sending
            document.getElementById('message').value = '';

            // Focus back to the input box after a short delay
            setTimeout(() => {
                document.getElementById('message').focus();
            }, 1000); // Delay of 1 second before refocusing

            // Display typing animation
            displayTypingAnimation();

            // Delay before getting the response
            await new Promise(resolve => setTimeout(resolve, 1000 + (message.length * 20))); // Delay proportional to message length

            const response = await fetch('/createGirlfriend', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userName: userName,
                    girlfriendName: girlfriendName,
                    girlfriendPersonality: girlfriendPersonality,
                    girlfriendInterests: girlfriendInterests,
                    conversationHistory: conversationHistory // Send entire conversation history
                })
            });

            const data = await response.json();
            conversationHistory.push({ role: 'girlfriend', content: data }); // Add girlfriend response to history

            // Hide typing animation
            hideTypingAnimation();

            // Display the girlfriend's message
            displayConversation(conversationHistory, userName, girlfriendName);
        }

        function displayConversation(conversation, userName, girlfriendName) {
            const girlfriendMessageContainer = document.getElementById('girlfriendMessage');
            let html = '';
            conversation.forEach(message => {
                if (message.role === 'user') {
                    html += `<div class="message user"><span class="username">${userName}</span>: ${message.content}</div>`;
                } else if (message.role === 'girlfriend') {
                    html += `<div class="message girlfriend"><span class="username">${girlfriendName}</span>: ${message.content}</div>`;
                }
            });
            girlfriendMessageContainer.innerHTML = html;
            girlfriendMessageContainer.scrollTop = girlfriendMessageContainer.scrollHeight; // Scroll to bottom
        }

        function displayTypingAnimation() {
            const typingMessage = document.createElement('div');
            typingMessage.className = 'message girlfriend typing-animation';
            typingMessage.innerHTML = `<span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>`;
            document.getElementById('girlfriendMessage').appendChild(typingMessage);
            document.getElementById('girlfriendMessage').scrollTop = document.getElementById('girlfriendMessage').scrollHeight;
        }

        function hideTypingAnimation() {
            const typingMessages = document.querySelectorAll('.typing-animation');
            typingMessages.forEach(message => {
                message.remove();
            });
        }
    </script>
</body>
</html>
